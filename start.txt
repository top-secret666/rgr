Write-Host "=== ОСТАНОВКА ВСЕХ КОНТЕЙНЕРОВ ===" -ForegroundColor Red
docker rm -f zookeeper kafka user-db restaurant-db order-db

Write-Host "`n=== ЗАПУСК ZOOKEEPER ===" -ForegroundColor Green
docker run -d --name zookeeper -p 2181:2181 -e ZOOKEEPER_CLIENT_PORT=2181 -e ZOOKEEPER_TICK_TIME=2000 confluentinc/cp-zookeeper:7.3.0
Start-Sleep -Seconds 5
docker logs zookeeper | Select-Object -Last 5

Write-Host "`n=== ЗАПУСК KAFKA ===" -ForegroundColor Green
docker run -d --name kafka -p 9092:9092 --link zookeeper:zookeeper -e KAFKA_BROKER_ID=1 -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9092 -e KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT -e KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 confluentinc/cp-kafka:7.3.0
Write-Host "Ожидание запуска Kafka..." -ForegroundColor Yellow
Start-Sleep -Seconds 15
docker logs kafka | Select-Object -Last 10

Write-Host "`n=== ЗАПУСК USER-DB ===" -ForegroundColor Green
docker run -d --name user-db -p 5432:5432 -e POSTGRES_USER=user -e POSTGRES_PASSWORD=password -e POSTGRES_DB=user_db -v user_db_data:/var/lib/postgresql/data postgres:14
Start-Sleep -Seconds 10
docker exec user-db pg_isready -U user -d user_db

Write-Host "`n=== ЗАПУСК RESTAURANT-DB ===" -ForegroundColor Green
docker run -d --name restaurant-db -p 5433:5432 -e POSTGRES_USER=user -e POSTGRES_PASSWORD=password -e POSTGRES_DB=restaurant_db -v restaurant_db_data:/var/lib/postgresql/data postgres:14
Start-Sleep -Seconds 10
docker exec restaurant-db pg_isready -U user -d restaurant_db

Write-Host "`n=== ЗАПУСК ORDER-DB ===" -ForegroundColor Green
docker run -d --name order-db -p 5434:5432 -e POSTGRES_USER=user -e POSTGRES_PASSWORD=password -e POSTGRES_DB=order_db -v order_db_data:/var/lib/postgresql/data postgres:14
Start-Sleep -Seconds 10
docker exec order-db pg_isready -U user -d order_db

Write-Host "`n=== ФИНАЛЬНАЯ ПРОВЕРКА ===" -ForegroundColor Cyan
docker ps
Write-Host "`nПроверка Kafka топиков:" -ForegroundColor Yellow
docker exec kafka kafka-topics --list --bootstrap-server localhost:9092